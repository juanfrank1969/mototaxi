<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mototaxis Monter铆a</title>
    
    <!-- Configuraci贸n para que Chrome la reconozca como App -->
    <meta name="theme-color" content="#ffcc00">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Mototaxi Monteria","short_name":"MotoApp","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#ffcc00","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3194/3194591.png","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .maxim-yellow { background-color: #ffcc00; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col overflow-hidden">

    <!-- Cabecera -->
    <header class="maxim-yellow p-4 flex items-center justify-between shadow-md z-20">
        <div class="flex items-center gap-2">
            <i data-lucide="bike" class="w-6 h-6"></i>
            <h1 class="font-black text-xl uppercase tracking-tighter">MOTOTAXIS MONTERA</h1>
        </div>
        <!-- Bot贸n de Instalaci贸n que aparecer谩 si el navegador lo permite -->
        <button id="btnInstalar" class="hidden bg-black text-white text-[10px] px-3 py-1 rounded-full font-bold animate-bounce">
            INSTALAR APP
        </button>
    </header>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        <!-- Mapa -->
        <div class="flex-1 w-full relative">
            <div id="map"></div>
        </div>

        <!-- Panel de Control Flotante (Estilo App M贸vil) -->
        <div class="absolute bottom-0 left-0 right-0 bg-white p-5 shadow-[0_-10px_25px_rgba(0,0,0,0.1)] z-10 rounded-t-[2.5rem] safe-area-bottom">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4"></div>
            
            <div class="space-y-3">
                <div class="relative">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-600"><i data-lucide="map-pin" class="w-4 h-4"></i></div>
                    <input type="text" id="origin" placeholder="Mi ubicaci贸n" class="w-full pl-10 pr-10 py-3 bg-gray-50 border-2 border-transparent focus:border-yellow-400 rounded-2xl text-sm font-bold shadow-inner">
                    <button onclick="handleOriginGPS()" class="absolute right-3 top-1/2 -translate-y-1/2 text-yellow-600"><i data-lucide="locate" class="w-5 h-5"></i></button>
                </div>

                <div class="relative">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-red-600"><i data-lucide="navigation" class="w-4 h-4"></i></div>
                    <input type="text" id="destination" onkeydown="if(event.key === 'Enter') autoCalculate()" placeholder="Destino (Ej: Unisin煤)" class="w-full pl-10 pr-4 py-3 bg-gray-50 border-2 border-transparent focus:border-yellow-400 rounded-2xl text-sm font-bold shadow-inner">
                </div>
            </div>

            <div id="trip-info" class="hidden mt-4 space-y-3">
                <div class="flex justify-between items-center bg-yellow-50 p-4 rounded-2xl border border-yellow-100">
                    <div>
                        <span class="text-[10px] font-bold text-yellow-700 uppercase block">Tarifa Estimada</span>
                        <p id="total-price" class="text-3xl font-black text-gray-900">$ 3.600</p>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] font-bold text-gray-400 uppercase block">Distancia</span>
                        <p id="distance-text" class="text-sm font-bold text-gray-700 italic">0.0 km</p>
                    </div>
                </div>
                <button onclick="enviarWhatsApp()" class="w-full bg-black text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                    PEDIR MOTO AHORA
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let map, routeLayer;
        
        // --- PARMETROS AJUSTADOS PARA MONTERA ---
        // $3.600 para 2.2km (Unisin煤)
        const BASE_FARE = 1800; 
        const KM_PRICE = 820; 
        const MIN_FARE = 2500;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([8.751, -75.881], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function handleOriginGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('origin').value = " Mi Ubicaci贸n Actual";
                    document.getElementById('origin').dataset.coords = `${pos.coords.longitude},${pos.coords.latitude}`;
                    if(document.getElementById('destination').value) autoCalculate();
                });
            }
        }

        async function autoCalculate() {
            const originVal = document.getElementById('origin').value;
            const destVal = document.getElementById('destination').value;
            if (!originVal || !destVal) return;

            try {
                const p1 = await geocode(originVal);
                const p2 = await geocode(destVal);
                if (!p1 || !p2) return;

                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lon},${p1.lat};${p2.lon},${p2.lat}?overview=full&geometries=geojson`);
                const data = await res.json();
                const distanceKm = (data.routes[0].distance / 1000).toFixed(2);

                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.geoJSON(data.routes[0].geometry, { style: { color: '#000', weight: 6 } }).addTo(map);
                map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });

                let price = Math.round((BASE_FARE + (parseFloat(distanceKm) * KM_PRICE)) / 100) * 100;
                if (price < MIN_FARE) price = MIN_FARE;

                document.getElementById('total-price').innerText = `$ ${price.toLocaleString('es-CO')}`;
                document.getElementById('distance-text').innerText = distanceKm + " km";
                document.getElementById('trip-info').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        async function geocode(text) {
            if (text.includes("Actual")) {
                const c = document.getElementById('origin').dataset.coords.split(',');
                return { lon: c[0], lat: c[1] };
            }
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${text}, Monteria&format=json&limit=1`);
            const data = await res.json();
            return data[0] ? { lon: data[0].lon, lat: data[0].lat } : null;
        }

        function enviarWhatsApp() {
            const origin = document.getElementById('origin').value;
            const dest = document.getElementById('destination').value;
            const price = document.getElementById('total-price').innerText;
            const msg = encodeURIComponent(`隆Hola! Necesito una moto:\n Origen: ${origin}\n Destino: ${dest}\n Tarifa: ${price}`);
            window.open(`https://wa.me/573000000000?text=${msg}`, '_blank'); // Cambia el n煤mero por el tuyo
        }

        // --- LGICA DE INSTALACIN ---
        let eventoInstalacion;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            eventoInstalacion = e;
            document.getElementById('btnInstalar').classList.remove('hidden');
        });

        document.getElementById('btnInstalar').addEventListener('click', async () => {
            if (eventoInstalacion) {
                eventoInstalacion.prompt();
                const { outcome } = await eventoInstalacion.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('btnInstalar').classList.add('hidden');
                }
                eventoInstalacion = null;
            }
        });

        window.onload = initMap;
    </script>
</body>
</html>
