<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MotoApp APK</title>
    
    <meta name="theme-color" content="#ffcc00">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000;
            font-family: system-ui, -apple-system, sans-serif;
        }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        .mini-header {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(255, 204, 0, 0.98);
            padding: 8px 15px; border-radius: 50px;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .mini-header h1 { margin: 0; font-size: 12px; font-weight: 900; text-transform: uppercase; }

        .bottom-panel {
            position: absolute; bottom: 20px; left: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.98);
            padding: 12px; border-radius: 18px;
            z-index: 1000; box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 8px;
        }
        .input-box {
            position: relative; display: flex; align-items: center;
            background: #f1f1f1; border-radius: 12px; padding: 0 12px; height: 45px;
        }
        .input-box input {
            width: 100%; border: none; background: transparent;
            font-size: 14px; font-weight: 600; outline: none; color: #333;
        }
        .gps-trigger { font-size: 20px; cursor: pointer; padding: 5px; color: #ffcc00; }

        .price-row {
            display: none; justify-content: space-between; align-items: center;
            background: #f0fff4; padding: 10px; border-radius: 12px; border: 1px solid #c6f6d5;
        }
        .price-val { font-size: 24px; font-weight: 900; color: #234e52; margin: 0; }
        .btn-go {
            width: 100%; background: #000; color: #fff;
            border: none; padding: 15px; border-radius: 15px;
            font-weight: 900; font-size: 16px; text-transform: uppercase; display: none;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <div class="mini-header">
        <h1>üèçÔ∏è MOTO MONTER√çA</h1>
    </div>

    <div id="map"></div>

    <div class="bottom-panel">
        <div class="input-box">
            <input type="text" id="origin" placeholder="üìç Ubicaci√≥n de recogida..." readonly>
            <span class="gps-trigger" id="gps-btn">üéØ</span>
        </div>

        <div class="input-box">
            <input type="text" id="destination" placeholder="üèÅ ¬øHacia d√≥nde vas? (Barrio/Sitio)">
        </div>

        <div id="res-box" class="price-row">
            <p id="total-price" class="price-val">$ 0</p>
            <p id="distance-text" style="font-size: 12px; font-weight: bold; color: #666; margin:0;">0.0 km</p>
        </div>

        <button id="btn-wa" class="btn-go">PEDIR AHORA</button>
    </div>

    <script>
        let mainMap, currentRouteLayer;
        const FEE_BASE = 1800; 
        const FEE_KM = 820; 

        function initApp() {
            try {
                mainMap = L.map('map', { zoomControl: false, attributionControl: false }).setView([8.751, -75.881], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mainMap);
                
                document.getElementById('gps-btn').addEventListener('click', getRealLocation);
                document.getElementById('destination').addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') calculateTrip();
                });
                document.getElementById('btn-wa').addEventListener('click', orderMoto);

                getRealLocation();
            } catch (err) {
                console.error("Error inicializando mapa:", err);
            }
        }

        async function getRealLocation() {
            const originInput = document.getElementById('origin');
            originInput.value = "üìç Buscando GPS...";

            // Intentar verificar permisos expl√≠citamente primero si el navegador lo permite
            if (navigator.permissions && navigator.permissions.query) {
                try {
                    const status = await navigator.permissions.query({ name: 'geolocation' });
                    if (status.state === 'denied') {
                        handleGeoError({ code: 1 }, originInput);
                        return;
                    }
                } catch (e) { console.log("Permissions API not supported"); }
            }

            const geoOptions = {
                enableHighAccuracy: true,
                timeout: 12000,
                maximumAge: 60000 
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => setMapToPosition(pos, originInput, "Exacta"),
                    (err) => {
                        console.warn("Fallo GPS alta precisi√≥n, intentando baja...");
                        navigator.geolocation.getCurrentPosition(
                            (pos) => setMapToPosition(pos, originInput, "Aproximada"),
                            (err2) => {
                                console.error("Fallo total Geolocation API:", err2);
                                tryIpLocation(originInput); // √öltimo recurso: Ubicaci√≥n por IP
                            },
                            { enableHighAccuracy: false, timeout: 5000 }
                        );
                    },
                    geoOptions
                );
            } else {
                tryIpLocation(originInput);
            }
        }

        function setMapToPosition(pos, input, type) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            input.value = `üìç Mi Ubicaci√≥n (${type})`;
            input.dataset.coords = `${lon},${lat}`;
            input.readOnly = true;
            mainMap.setView([lat, lon], 16);
            if (window.userMarker) mainMap.removeLayer(window.userMarker);
            window.userMarker = L.marker([lat, lon]).addTo(mainMap).bindPopup("Est√°s aqu√≠").openPopup();
        }

        async function tryIpLocation(input) {
            console.log("Intentando ubicaci√≥n por IP...");
            try {
                // Usamos un servicio gratuito de IP-API para Monter√≠a/C√≥rdoba
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                if (data.latitude && data.longitude) {
                    const fakePos = { coords: { latitude: data.latitude, longitude: data.longitude } };
                    setMapToPosition(fakePos, input, "Red");
                } else {
                    throw new Error("IP data invalid");
                }
            } catch (e) {
                handleGeoError({ code: 0 }, input);
            }
        }

        function handleGeoError(err, input) {
            input.value = "";
            input.placeholder = "Escribe tu direcci√≥n o barrio...";
            input.readOnly = false;
            mainMap.setView([8.751, -75.881], 14);
            
            let msg = "No pudimos encontrarte autom√°ticamente.";
            if (err.code === 1) msg = "Acceso al GPS denegado. Por favor, activa los permisos en los ajustes del celular.";
            
            console.warn("GeoError Final:", msg);
            // Mensaje suave en el placeholder en lugar de alert intrusivo
            input.placeholder = "GPS fall√≥. Escribe el origen aqu√≠.";
        }

        async function calculateTrip() {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            if(!origin || !destination) return;

            document.activeElement.blur(); 

            try {
                const coord1 = await geocodeAddress(origin, true);
                const coord2 = await geocodeAddress(destination, false);
                
                const routeUrl = `https://router.project-osrm.org/route/v1/driving/${coord1.lon},${coord1.lat};${coord2.lon},${coord2.lat}?overview=full&geometries=geojson`;
                const response = await fetch(routeUrl);
                const data = await response.json();
                
                if (!data.routes || data.routes.length === 0) throw new Error("Sin ruta");

                const km = (data.routes[0].distance / 1000).toFixed(2);

                if (currentRouteLayer) mainMap.removeLayer(currentRouteLayer);
                currentRouteLayer = L.geoJSON(data.routes[0].geometry, { style: { color: '#000', weight: 6 } }).addTo(mainMap);
                mainMap.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 150] });

                let price = Math.round((FEE_BASE + (parseFloat(km) * FEE_KM)) / 100) * 100;
                if(price < 2500) price = 2500;

                document.getElementById('total-price').innerText = `$ ${price.toLocaleString('es-CO')}`;
                document.getElementById('distance-text').innerText = km + " km";
                document.getElementById('res-box').style.display = 'flex';
                document.getElementById('btn-wa').style.display = 'block';
            } catch (e) { 
                alert("Error al calcular. Escribe el nombre del barrio correctamente."); 
            }
        }

        async function geocodeAddress(query, isOrigin) {
            if (isOrigin && query.includes("üìç")) {
                const coordsAttr = document.getElementById('origin').dataset.coords;
                if (coordsAttr) {
                    const c = coordsAttr.split(',');
                    return { lon: c[0], lat: c[1] };
                }
            }
            const searchUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}, Monteria&format=json&limit=1`;
            const response = await fetch(searchUrl);
            const data = await response.json();
            if (data.length === 0) throw new Error("No encontrado");
            return { lon: data[0].lon, lat: data[0].lat };
        }

        function orderMoto() {
            const dest = document.getElementById('destination').value;
            const price = document.getElementById('total-price').innerText;
            const message = `Pedido Moto:%0Aüìç Origen: Mi Ubicaci√≥n%0AüèÅ Destino: ${dest}%0Aüí∞ Tarifa: ${price}`;
            window.open(`https://wa.me/573000000000?text=${message}`, '_blank');
        }

        window.addEventListener('load', initApp);
    </script>
</body>
</html>
