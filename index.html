<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MotoApp Monter√≠a</title>
    
    <meta name="theme-color" content="#ffcc00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { --primary: #ffcc00; --dark: #121212; --light: #ffffff; --gray: #f8f9fa; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body, html { height: 100%; width: 100%; overflow: hidden; background: var(--dark); font-family: 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: #ddd; }

        .app-header {
            position: absolute; top: 15px; left: 15px; right: 15px;
            background: var(--primary); padding: 12px; border-radius: 18px;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        .app-header h1 { font-size: 15px; font-weight: 900; color: #000; text-transform: uppercase; }

        .bottom-panel {
            position: absolute; bottom: 25px; left: 12px; right: 12px;
            background: var(--light); padding: 20px; border-radius: 28px;
            z-index: 1000; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 12px;
        }

        .input-box {
            background: var(--gray); border-radius: 15px; padding: 5px 15px;
            display: flex; align-items: center; border: 1px solid #eee;
        }
        .input-box input {
            width: 100%; border: none; background: transparent; height: 48px;
            font-size: 16px; outline: none; font-weight: 600; color: #333;
        }
        .icon-gps { color: var(--primary); font-size: 24px; cursor: pointer; padding: 5px; }

        .price-tag {
            display: none; background: #edfff9; border: 1px solid #c6f6d5;
            padding: 15px; border-radius: 18px; justify-content: space-between; align-items: center;
        }
        .price-tag .amount { font-size: 30px; font-weight: 900; color: #234e52; }

        .btn-order {
            width: 100%; background: var(--dark); color: white; border: none;
            padding: 18px; border-radius: 18px; font-weight: 800; font-size: 16px;
            text-transform: uppercase; display: none;
        }

        /* Pantalla de Error GPS Mejorada */
        #gps-error {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 9999; flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center; padding: 40px;
        }
        .btn-fix { background: var(--primary); color: #000; padding: 16px; border-radius: 15px; font-weight: bold; margin-top: 20px; width: 100%; border: none; }
        .btn-manual { background: transparent; color: white; border: 1px solid white; padding: 12px; border-radius: 15px; margin-top: 10px; width: 100%; }
        
        #loading-overlay {
            position: fixed; inset: 0; background: var(--primary); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <div id="loading-overlay">
        <h2 style="font-weight: 900; font-style: italic;">MOTOAPP</h2>
        <p>Cargando mapa de Monter√≠a...</p>
    </div>

    <div id="gps-error">
        <div style="background: #333; padding: 30px; border-radius: 30px; border: 2px solid var(--primary);">
            <h2 style="color:var(--primary); margin-bottom:10px;">üìç ERROR DE UBICACI√ìN</h2>
            <p id="error-msg">Aseg√∫rate de tener el GPS encendido y haber dado permisos en el navegador.</p>
            <button class="btn-fix" onclick="obtenerGPS()">REINTENTAR AHORA</button>
            <button class="btn-manual" onclick="activarModoManual()">SELECCIONAR EN MAPA</button>
        </div>
    </div>

    <div class="app-header">
        <h1>MotoApp Monter√≠a üèçÔ∏è</h1>
    </div>

    <div id="map"></div>

    <div class="bottom-panel">
        <div class="input-box">
            <input type="text" id="origin" placeholder="üìç Toca el mapa o usa GPS..." readonly>
            <span class="icon-gps" onclick="obtenerGPS()">üéØ</span>
        </div>

        <div class="input-box">
            <input type="text" id="destination" onkeydown="if(event.key==='Enter') calcularRuta()" placeholder="üèÅ ¬øA qu√© barrio vas?">
        </div>

        <div id="res-box" class="price-tag">
            <span id="total-price" class="amount">$ 0</span>
            <div style="text-align: right;">
                <p id="dist-text" style="font-weight: bold;">0.0 km</p>
                <p style="font-size: 10px; color: #666;">TARIFA SUGERIDA</p>
            </div>
        </div>

        <button id="btn-wa" onclick="enviarPedido()" class="btn-order">PEDIR MOTO YA</button>
    </div>

    <script>
        let map, route, userMarker;
        const PRECIO_BASE = 1800, PRECIO_KM = 820;

        function iniciarApp() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([8.751, -75.881], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click', function(e) {
                actualizarPosicion({ coords: { latitude: e.latlng.lat, longitude: e.latlng.lng }}, true);
            });

            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                map.invalidateSize();
                obtenerGPS();
            }, 1500);
        }

        // FUNCI√ìN MEJORADA: Resuelve el error de objeto vac√≠o {}
        function obtenerGPS() {
            const originInput = document.getElementById('origin');
            originInput.value = "‚è≥ Localizando...";
            document.getElementById('gps-error').style.display = 'none';

            if (!navigator.geolocation) {
                activarModoManual();
                return;
            }

            // Opciones optimizadas para evitar el error de timeout y objeto vac√≠o
            const options = { 
                enableHighAccuracy: true, 
                timeout: 15000, // Aumentado a 15 seg para dar tiempo al hardware
                maximumAge: 0 
            };

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    actualizarPosicion(pos, false);
                },
                (err) => {
                    console.log("Detalle t√©cnico del error:", err.code, err.message);
                    // Si falla la alta precisi√≥n, intentamos una vez m√°s con baja precisi√≥n
                    navigator.geolocation.getCurrentPosition(
                        (pos) => actualizarPosicion(pos, false),
                        () => { document.getElementById('gps-error').style.display = 'flex'; },
                        { enableHighAccuracy: false, timeout: 5000 }
                    );
                }, 
                options
            );
        }

        function activarModoManual() {
            document.getElementById('gps-error').style.display = 'none';
            document.getElementById('origin').value = "üìç Toca el mapa para tu origen";
        }

        function actualizarPosicion(position, manual = false) {
            const { latitude, longitude } = position.coords;
            const originInput = document.getElementById('origin');
            
            originInput.value = manual ? "üìç Origen en el mapa" : "üìç Mi Ubicaci√≥n";
            originInput.dataset.coords = `${longitude},${latitude}`;
            
            if (!manual) map.setView([latitude, longitude], 16);
            if (userMarker) map.removeLayer(userMarker);
            
            userMarker = L.circleMarker([latitude, longitude], {
                radius: 10, color: '#fff', fillColor: manual ? '#ff8800' : '#007bff', fillOpacity: 1, weight: 3
            }).addTo(map);

            document.getElementById('gps-error').style.display = 'none';
        }

        async function calcularRuta() {
            const destino = document.getElementById('destination').value;
            const origenCoords = document.getElementById('origin').dataset.coords;
            
            if(!destino || !origenCoords) {
                alert("Primero marca tu ubicaci√≥n (GPS o mapa)");
                return;
            }

            try {
                const inicio = origenCoords.split(',');
                const resGeo = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(destino)}, Monteria, Colombia&format=json&limit=1`);
                const dataGeo = await resGeo.json();
                
                if(dataGeo.length === 0) {
                    alert("Barrio no encontrado. Escribe el nombre exacto.");
                    return;
                }

                const fin = [dataGeo[0].lon, dataGeo[0].lat];
                const resRoute = await fetch(`https://router.project-osrm.org/route/v1/driving/${inicio[0]},${inicio[1]};${fin[0]},${fin[1]}?overview=full&geometries=geojson`);
                const dataRoute = await resRoute.json();
                
                const distanciaKm = (dataRoute.routes[0].distance / 1000).toFixed(2);
                
                if (route) map.removeLayer(route);
                route = L.geoJSON(dataRoute.routes[0].geometry, { style: { color: '#000', weight: 6 } }).addTo(map);
                map.fitBounds(route.getBounds(), { padding: [50, 180] });

                let precioFinal = Math.round((PRECIO_BASE + (parseFloat(distanciaKm) * PRECIO_KM)) / 100) * 100;
                if(precioFinal < 2500) precioFinal = 2500;

                document.getElementById('total-price').innerText = `$ ${precioFinal.toLocaleString('es-CO')}`;
                document.getElementById('dist-text').innerText = distanciaKm + " km";
                document.getElementById('res-box').style.display = 'flex';
                document.getElementById('btn-wa').style.display = 'block';

            } catch (err) {
                alert("Error calculando ruta.");
            }
        }

        function enviarPedido() {
            const dest = document.getElementById('destination').value;
            const precio = document.getElementById('total-price').innerText;
            const url = `https://wa.me/573000000000?text=¬°Nueva Carrera!%0Aüìç Origen: Marcado en App%0AüèÅ Destino: ${dest}%0Aüí∞ Precio sugerido: ${precio}`;
            window.open(url, '_blank');
        }

        window.addEventListener('load', iniciarApp);
    </script>
</body>
</html>
